<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WREN AI Companion</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* ===== Global Styles ===== */
    html, body {
      margin: 0; padding: 0;
      font-family: 'Quicksand', sans-serif;
      background: #f9f9f9;
      height: 100%;
      color: #333;
      transition: background-color 0.5s ease, color 0.5s ease;
      user-select: none;
    }
    body.dark-mode {
      background: #121212;
      color: #ddd;
    }
    body.dark-mode main {
      background: linear-gradient(to right, #222, #333);
      color: #eee;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
    }

    /* ===== Intro Screen ===== */
    #introScreen {
      position: fixed;
      z-index: 9999;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: black;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 1.5s ease;
    }
    #introScreen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    .eyes {
      position: absolute;
      top: calc(50% - 80px);
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 24px;
      animation: fadeIn 2s forwards 1.5s;
      pointer-events: none;
      width: 80px;
      justify-content: center;
    }
    .eye {
      width: 20px; height: 20px;
      background: white;
      border-radius: 50%;
      animation: blink 4s infinite;
    }
    .eye:nth-child(2) {
      animation-delay: 2s;
    }
    @keyframes blink {
      0%, 90%, 100% { height: 20px; }
      95% { height: 2px; }
    }

    #introText {
      text-align: center;
      position: relative;
      margin-top: 40px;
    }
    #introLine1 {
      font-size: 1.4rem;
      margin: 0 0 8px 0;
      opacity: 0;
      animation: fadeIn 2s forwards 0.5s;
      line-height: 1.2;
      font-weight: 400;
      color: #ccc;
    }
    #introLine2 {
      font-size: 2.2rem;
      font-weight: 900;
      color: white;
      text-shadow: 0 0 5px white, 0 0 10px white, 0 0 20px white, 0 0 30px white;
      opacity: 0;
      animation: fadeIn 2s forwards 2.5s, wrenGlow 3s infinite ease-in-out 4.5s;
      line-height: 1.1;
      letter-spacing: 0.06em;
    }
    #introStar {
      display: block;
      margin: 20px auto 0;
      width: 60px; height: 60px;
      opacity: 0;
      animation: fadeIn 2s forwards 3.5s, starPulse 3s infinite ease-in-out 5s;
    }
    @keyframes starPulse {
      0%, 100% { fill: #1e88e5; opacity: 1; }
      50% { fill: #1e88e5; opacity: 0.7; }
    }
    @keyframes wrenGlow {
      0%, 100% {
        text-shadow: 0 0 5px white, 0 0 10px white, 0 0 20px white, 0 0 30px white;
        color: white;
      }
      50% {
        text-shadow: 0 0 2px white, 0 0 6px white, 0 0 10px white;
        color: white;
      }
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }

    /* ===== Main App Styles ===== */
    main {
      display: none;
      max-width: 700px;
      margin: 40px auto 60px auto;
      padding: 30px 25px;
      background: linear-gradient(to right, #e3f2fd, #fbe9e7);
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      color: #333;
      box-sizing: border-box;
      min-height: 300px;
      transition: background 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 25px;
      user-select: none;
    }
    label {
      margin-top: 18px;
      display: block;
      font-weight: 600;
      font-size: 1rem;
      color: #444;
      user-select: none;
    }
    input, select {
      padding: 12px 15px;
      margin-top: 8px;
      width: 100%;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
      background: white;
      color: #333;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
    }
    button {
      padding: 14px 0;
      font-size: 1.1rem;
      width: 100%;
      margin-top: 22px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background-color: #388e3c;
    }
    button:disabled {
      background-color: #a5d6a7;
      cursor: wait;
    }
    #response, #modeResponse {
      margin-top: 22px;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
      white-space: normal;
      min-height: 2.2em;
      font-size: 1rem;
      color: #222;
      user-select: text;
      transition: background 0.5s ease, color 0.5s ease;
    }
    #modeSection {
      display: none;
      margin-top: 32px;
    }
    #bookCategoryGroup {
      display: none;
      margin-top: 18px;
    }


    #modeInstructions {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #555;
      min-height: 10em;
      font-style: italic;
      white-space: pre-wrap;
      transition: color 0.5s ease;
    }
    #translationOptions {
      margin-top: 18px;
      padding: 12px 15px;
      background: #f0f4f8;
      border-radius: 10px;
      display: none;
      user-select: none;
      transition: background 0.5s ease, color 0.5s ease;
    }
    #translationOptions label {
      font-weight: normal;
      margin-right: 20px;
      cursor: pointer;
    }
    #translationOptions select {
      width: auto;
      display: inline-block;
      margin-left: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode #response,
    body.dark-mode #modeResponse,
    body.dark-mode #translationOptions {
      background: #222;
      color: #ddd;
      border-color: #555;
    }
    body.dark-mode #modeInstructions {
      color: #ccc;
    }
  </style>
</head>
<body>
  <!-- ========== INTRO SCREEN ========== -->
  <div id="introScreen" aria-label="Welcome Screen" role="dialog" aria-modal="true">
    <div class="eyes" aria-hidden="true">
      <div class="eye"></div>
      <div class="eye"></div>
    </div>
    <div id="introText">
      <div id="introLine1">Hello there, friend</div>
      <div id="introLine2">I'm WREN</div>
      <!-- Star SVG -->
      <svg id="introStar" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="60" height="60" aria-hidden="true" focusable="false">
        <polygon points="32,4 39,24 60,24 42,38 48,60 32,46 16,60 22,38 4,24 25,24" fill="#1e88e5"/>
      </svg>
    </div>
  </div>

  <!-- ========== MAIN APP ========== -->
  <main role="main" aria-live="polite">
    <h1 id="mainTitle">üëã Meet WREN ‚Äî Your AI Companion</h1>

    <!-- Dark Mode Toggle -->
    <label for="darkModeToggle" id="darkModeLabel" style="user-select:none; margin-bottom: 10px; cursor:pointer;">
      <input type="checkbox" id="darkModeToggle" /> Toggle Dark Mode
    </label>

    <label for="nameInput" id="nameLabel">üìù Enter your name:</label>
    <input type="text" id="nameInput" placeholder="Your name here..." autocomplete="off" aria-describedby="nameLabel" />

    <button id="startBtn" type="button">Start</button>

    <div id="response" aria-live="polite"></div>
    <div id="video-info"></div>	


    <section id="modeSection" aria-label="Mode Selection and Interaction">
      <label for="modeInput" id="modeLabel">üéØ Choose a Mode:</label>
      <select id="modeInput" aria-describedby="modeInstructions" aria-required="true">
        <option value="">-- Select a Mode --</option>
        <option value="1">ü§ñ Name Recognition</option>
        <option value="math">üßÆ Math Problem Solver</option>
        <option value="science">üî¨ Science Explainer</option>
        <option value="3">üìö Book Recommender</option>
        <option value="4">üí∞ Budget Tracker</option>
        <option value="5">ü©∫ Depression Screening</option>
        <option value="6">üè† House Tidying</option>
        <option value="7">üéô Voice GUI Assistant</option>
        <option value="8">üìú Memory Logs</option>
        <option value="10">‚è∞ Task Reminder</option>
      </select>

      <div id="modeInstructions" aria-live="polite" aria-atomic="true">
        <!-- Mode-specific instructions will show here -->
      </div>

      <div id="bookCategoryGroup">
  <label for="bookCategory" id="bookCategoryLabel">Choose a book category:</label>
  <select id="bookCategory" aria-describedby="bookCategoryLabel">
    <option value="">-- Select a Category --</option>
    <!-- Categories will be dynamically inserted here -->
  </select>
</div>

      <div id="bookTypeGroup" style="margin-top: 16px;">
  <label id="bookTypeLabel">What kind of recommendation do you want?</label><br />
  <label><input type="radio" name="bookType" value="1" /> üìñ Book</label><br />
  <label><input type="radio" name="bookType" value="2" /> üéß Audiobook/Video</label><br />
  <label><input type="radio" name="bookType" value="3" checked /> üìö + üéß Both</label>
</div>	

      <div id="translationOptions">
        <label for="translateFrom" id="translateFromLabel">From:</label>
        <select id="translateFrom">
          <option value="auto">Auto Detect</option>
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <option value="zh">Chinese</option>
          <option value="ja">Japanese</option>
        </select>

        <label for="translateTo" id="translateToLabel">To:</label>
        <select id="translateTo">
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <option value="zh">Chinese</option>
          <option value="ja">Japanese</option>
        </select>
      </div>

      <button id="sendBtn" type="button" disabled>Send</button>

      <div id="modeResponse" aria-live="polite" aria-atomic="true"></div>
    </section>
  </main>

  <script>
      window.addEventListener('load', () => {
    const intro = document.getElementById('introScreen');
    const main = document.querySelector('main');

    setTimeout(() => {
      intro.classList.add('fade-out');

      setTimeout(() => {
        intro.style.display = 'none';
        main.style.display = 'block';
        main.classList.add('fade-in');
        document.getElementById('nameInput').focus();
      }, 1500);
    }, 7000);
  });

  // ===== Dark mode toggle =====
  const darkModeToggle = document.getElementById('darkModeToggle');
  darkModeToggle.addEventListener('change', () => {
    document.body.classList.toggle('dark-mode', darkModeToggle.checked);
  });

  // ===== Elements =====
  const startBtn = document.getElementById('startBtn');
  const responseDiv = document.getElementById('response');
  const modeSection = document.getElementById('modeSection');
  const modeInput = document.getElementById('modeInput');
  const sendBtn = document.getElementById('sendBtn');
  const modeResponse = document.getElementById('modeResponse');
  const nameInput = document.getElementById('nameInput');
  const bookCategoryGroup = document.getElementById('bookCategoryGroup');
  const bookCategorySelect = document.getElementById('bookCategory');
  const modeInstructions = document.getElementById('modeInstructions');
  const translationOptions = document.getElementById('translationOptions');

  // ===== Helper: Update mode instructions and UI =====
  function updateModeUI() {
    const selected = modeInput.value;
    modeResponse.textContent = '';
    sendBtn.disabled = !selected;


    const bookTypeGroup = document.getElementById('bookTypeGroup');

if (selected === '3') {
  bookCategoryGroup.style.display = 'block';
  bookTypeGroup.style.display = 'block';
} else {
  bookCategoryGroup.style.display = 'none';
  bookCategorySelect.value = '';
  bookTypeGroup.style.display = 'none';
}

    const instructionsMap = {
      '1': 'Enter text related to names for recognition.',
      'math': 'Type a math problem, e.g., 12 * 7 or sqrt(16).',
      'science': 'Ask a science question or concept to explain.',
      '3': 'Select a book category and ask for recommendations.',
      '4': 'Input your budget details to track expenses.',
      '5': 'Answer some questions to screen for depression.',
      '6': 'Describe your house tidying needs.',
      '7': 'Use voice commands to interact with WREN.',
      '8': 'Request your memory logs.',
      '10': 'Set reminders for your tasks.',
    };
    modeInstructions.textContent = instructionsMap[selected] || 'Select a mode to get instructions.';
  }

  modeInput.addEventListener('change', updateModeUI);

  // ===== Start button handler =====
  startBtn.addEventListener("click", async () => {
    const name = nameInput.value.trim();

    if (!name) {
      responseDiv.innerText = "‚ö†Ô∏è Please enter your name first.";
      return;
    }

    try {
      const response = await fetch("/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ name })
      });

      const result = await response.json();

      if (result.success) {
        responseDiv.innerText = result.response || `‚úÖ Hello, ${name}! WREN is ready to assist you.`;
        modeSection.style.display = 'block';
        modeInput.focus();
        startBtn.disabled = true;
        nameInput.disabled = true;
      } else {
        responseDiv.innerText = `‚ùå ${result.error}`;
      }
    } catch (error) {
      console.error("Error:", error);
      responseDiv.innerText = "‚ùå Something went wrong. Try again.";
    }
  });

  // ===== Send button handler =====
  sendBtn.addEventListener('click', async () => {
  const mode = modeInput.value;
  const userId = nameInput.value.trim();

  if (!mode) {
    modeResponse.textContent = '‚ö†Ô∏è Please select a mode.';
    return;
  }

  if (!userId) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter your name and start first.';
    return;
  }

  // Prepare payload
  const payload = { userId, mode };
  sendBtn.disabled = true;
  modeResponse.textContent = 'Loading...';

  // Book Recommender Mode
  if (mode === '3') {
    const selectedCategory = bookCategorySelect.value;
    const selectedType = document.querySelector('input[name="bookType"]:checked');

    if (!selectedCategory) {
      modeResponse.textContent = '‚ö†Ô∏è Please select a book category.';
      sendBtn.disabled = false;
      return;
    }

    if (!selectedType) {
      modeResponse.textContent = '‚ö†Ô∏è Please select what kind of recommendation you want.';
      sendBtn.disabled = false;
      return;
    }

    payload.choice = selectedCategory;
    payload.bookType = selectedType.value;
    payload.topic = selectedCategory;
  }

  // Translation Mode
  if (mode === 'translate') {
    payload.translateFrom = document.getElementById('translateFrom').value;
    payload.translateTo = document.getElementById('translateTo').value;

    const textToTranslate = prompt('Enter the text you want to translate:', '');
    if (textToTranslate === null || textToTranslate.trim() === '') {
      modeResponse.textContent = 'Translation cancelled.';
      sendBtn.disabled = false;
      return;
    }

    payload.topic = textToTranslate.trim();
  }

  // Other Modes (require prompt input)
  if (mode !== '3' && mode !== 'translate') {
    const userInput = prompt('Enter input for the selected mode:', '');
    if (userInput === null || userInput.trim() === '') {
      modeResponse.textContent = 'Input cancelled.';
      sendBtn.disabled = false;
      return;
    }

    payload.topic = userInput.trim();
  }

  // Send payload to backend
  try {
    const res = await fetch('/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const data = await res.json();

    if (data.success) {
      modeResponse.textContent = data.response || '‚úÖ Success.';

      if (Array.isArray(data.books)) {
        modeResponse.textContent += '\n\nüìö Book recommendations:\n' + data.books.join('\n');
      }

    

      if (Array.isArray(data.audiobooks) && data.audiobooks.length > 0) {
  const audiobooksHtml = data.audiobooks.map(book => {
    const url = book?.url || '';
    const videoIdMatch = url.match(/(?:v=|\.be\/)([\w-]{11})/);
    const videoId = videoIdMatch ? videoIdMatch[1] : null;
    const linkId = videoId ? `yt-link-${videoId}` : `yt-link-${Math.random().toString(36).substr(2, 5)}`;

    return `
      <p>
        <strong>${book.title || 'Untitled'}</strong>: 
        <a href="${url}" 
           target="_blank" 
           id="${linkId}"
           ${videoId ? `onclick="getYouTubeVideoInfo('${videoId}'); return false;"` : ''}
        >
           ${url || 'Link not available'}
        </a>
      </p>`;
  }).join('');

  modeResponse.innerHTML += '<h3>üéß Audiobooks:</h3>' + audiobooksHtml;
}  
 else {
  modeResponse.innerHTML += '<h3>üéß Audiobooks:</h3><p>No audiobooks found.</p>';
}

    } else {
      modeResponse.textContent = `‚ùå Error: ${data.error || 'Unknown error.'}`;
    }

  } catch (err) {
    console.error(err);
    modeResponse.textContent = '‚ùå Network error fetching mode response.';
  } finally {
    sendBtn.disabled = false;
  }
});

document.addEventListener('DOMContentLoaded', () => {
  fetch('/api/book-categories')
    .then(response => response.json())
    .then(categories => {
      const bookCategorySelect = document.getElementById('bookCategory');
      bookCategorySelect.innerHTML = '<option value="">-- Select a Category --</option>';
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        bookCategorySelect.appendChild(option);
      });
    })
    .catch(err => {
      console.error('Failed to load categories:', err);
    });
});

 

async function getYouTubeVideoInfo(videoId) {
  try {
    const response = await fetch(`/api/youtube-video-info/${videoId}`);
    if (!response.ok) {
      throw new Error('Failed to fetch video info');
    }
    const data = await response.json();
    return data;
  } catch (error) {
    console.error(error);
    return null;
  }
}


  </script>
</body>
</html>
