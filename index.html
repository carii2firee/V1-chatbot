<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>WREN AI Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet"/>
    <style>
        /* ===== Global Styles ===== */



        #startContainer {
      max-width: 320px;
      margin: 40px auto 30px auto; /* centers horizontally and adds vertical spacing */
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px; /* space between elements */
    }

    #startContainer label {
      font-weight: 600;
      font-size: 1rem;
      color: #444;
      user-select: none;
      text-align: center;
      width: 100%;
    }

        html, body {
          margin: 0; padding: 0;
          font-family: 'Quicksand', sans-serif;
          background: #f9f9f9;
          height: 100%;
          color: #333;
          transition: background-color 0.5s ease, color 0.5s ease;
          user-select: none;
        }
        body.dark-mode {
          background: #121212;
          color: #ddd;
        }
        body.dark-mode main {
          background: linear-gradient(to right, #222, #333);
          color: #eee;
          box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

             #video-info {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.6s ease, transform 0.6s ease;
      pointer-events: none;
    }

    #video-info.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    body.dark-mode #video-info {
      background: #1e1e1e;
      color: #ddd;
    }

        /* ===== Intro Screen ===== */
        #introScreen {
          position: fixed;
          z-index: 9999;
          top: 0; left: 0;
          width: 100vw; height: 100vh;
          background: black;
          color: white;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          transition: opacity 1.5s ease;
        }
        #introScreen.fade-out {
          opacity: 0 !important;
          pointer-events: none;
        }
        .eyes {
          display: flex;
          gap: 24px;
          justify-content: center;
          pointer-events: none;
          transform-origin: center; /* rotates around the center */
          animation: eyesTilt 2s cubic-bezier(.68,-0.55,.27,1.55) forwards 2.2s;
          }

          .eye {
          width: 20px;
          height: 20px;
          background: white;
          border-radius: 50%;
          animation: blink 4s infinite;
          }

          .eye:nth-child(2) {
          animation-delay: 2s;
          }

        @keyframes eyesTilt {
          0% { transform: rotate(0deg); }
          50% { transform: rotate(0deg); }
          100% { transform: rotate(-9deg); } 
          }


        @keyframes blink {
          0%, 90%, 100% { height: 20px; }
          95% { height: 2px; }
        }

        #introText {
          text-align: center;
          position: relative;
          margin-top: 40px;
          display: inline-block;
          }
        #introLine1 {
          font-size: 1.4rem;
          margin: 0 0 8px 0;
          opacity: 0;
          animation: fadeIn 2s forwards 0.5s;
          line-height: 1.2;
          font-weight: 400;
          color: #ccc;
        }
        #introLine2 {
          font-size: 2.2rem;
          font-weight: 900;
          color: white;
          text-shadow: 0 0 5px white, 0 0 10px white, 0 0 20px white, 0 0 30px white;
          opacity: 0;
          animation: fadeIn 2s forwards 2.5s, wrenGlow 3s infinite ease-in-out 4.5s;
          line-height: 1.1;
          letter-spacing: 0.06em;
        }
        #orbitalWrapper {
          position: absolute;
          top: 50%;
          left: 50%;
          width: 0;
          height: 0;
          transform-origin: center;
          pointer-events: none;
          animation: orbitText 32s linear 4.5s forwards;
          }

        #introBall {
          width: 14px;
          height: 14px;
          background: #1e88e5;
          border-radius: 50%;
          box-shadow: 0 0 8px rgba(30,136,229,0.9);
          transform: translateX(130px);
          position: relative;
          animation:
          ballPulse 6s infinite ease-in-out,
          disperseMist 2s ease-out 52.5s forwards;
          }
          #introBall::after {
          content: '';
          position: absolute;
          top: 0; left: 0;
          width: 14px;
          height: 14px;
          border-radius: 50%;
          background: rgba(30,136,229,0.3);
          filter: blur(6px);
          transform: translateX(-2px) translateY(-2px); /* slight offset for natural trailing effect */
          pointer-events: none;
          }
          
           @keyframes orbitText {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(720deg); }  // === Change the rotation of the blue ball effect ========
          }

          /* Mist effect after rotations */
          @keyframes disperseMist {
            0% {
               opacity: 1;
               filter: blur(4px);
               transform: scale(1);
             }
              100% {
              opacity: 0;
              filter: blur(16px);
            }
          }

          @keyframes ballPulse {
          0%, 100% { opacity: 0.9; box-shadow: 0 0 8px rgba(30,136,229,0.8); }
          50%      { opacity: 1;   box-shadow: 0 0 16px rgba(30,136,229,1); }
          }

          @keyframes wrenGlow {
             0%, 100% {
               text-shadow: 0 0 4px white, 0 0 8px white, 0 0 15px white;
          }
          50% {
               text-shadow: 0 0 3px white, 0 0 8px white;
          }
          }

          @keyframes fadeIn {
          to { opacity: 1; }
          }





        /* ===== Main App Styles ===== */
        main {
          display: none;
          max-width: 700px;
          margin: 40px auto 60px auto;
          padding: 30px 25px;
          background: rgba(255, 255, 255, 0.15); /* soft translucent background */
          backdrop-filter: blur(10px);           /* frosted glass effect */
          border-radius: 20px;                    /* gentle curves */
          box-shadow: 0 4px 20px rgba(0,0,0,0.08); /* subtle floating shadow */
          color: #333;
          box-sizing: border-box;
          min-height: 300px;
          transition: background 0.5s ease, color 0.5s ease, box-shadow 0.5s ease, transform 0.3s ease;
          }

          main:hover {
          transform: translateY(-2px);             /* subtle lift on hover */
          box-shadow: 0 0 25px rgba(0, 150, 255, 0.6),      /* blue glow */
              0 8px 30px rgba(0,0,0,0.1);           /* subtle shadow for depth */
          }
        h1 {
          text-align: center;
          color: #2c3e50;
          margin-bottom: 25px;
          user-select: none;
        }
        label {
          margin-top: 18px;
          display: block;
          font-weight: 600;
          font-size: 1rem;
          color: #444;
          user-select: none;
        }
        input, select {
          padding: 12px 15px;
          margin-top: 8px;
          width: 100%;
          font-size: 1rem;
          border: 1px solid #ccc;
          border-radius: 8px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          background: white;
          color: #333;
        }
        input:focus, select:focus {
          outline: none;
          border-color: #4caf50;
          box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
        }
        button {
          padding: 14px 0;
          font-size: 1.1rem;
          width: 100%;
          margin-top: 22px;
          background-color: #4caf50;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          transition: background-color 0.3s ease;
          user-select: none;
        }
        button:hover:not(:disabled) {
          background-color: #388e3c;
        }
        button:disabled {
          background-color: #a5d6a7;
          cursor: wait;
        }
        #response, #modeResponse {
          margin-top: 22px;
          background: #fff;
          padding: 20px;
          border-radius: 12px;
          box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
          font-size: 1rem;
          color: #222;
          user-select: text;
          transition: background 0.5s ease, color 0.5s ease;


          white-space: pre-wrap;        /* Preserve line breaks and wrap lines */
          word-wrap: break-word;        /* Break long words if needed */
          overflow-y: auto;             /* Allow scrolling if content is tall */
          max-height: 350px;            /* Limit height so it doesn‚Äôt take over the screen */
          font-family: monospace
        }
        #modeSection {
          display: none;
          margin-top: 32px;
        }
        #bookCategoryGroup {
          display: none;
          margin-top: 18px;
        }

        #modeUIContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 32px;
    }

    #modeSection {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    #modeTextInput,
    #user-input {
      width: 300px;
      max-width: 90%;
      margin-top: 8px;
    }

    #modeTextInputGroup,
    #queryInputGroup {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

        #modeInstructions {
          margin-top: 8px;
          font-size: 0.9rem;
          color: #555;
          min-height: 10em;
          font-style: italic;
          white-space: pre-wrap;
          transition: color 0.5s ease;
        }
        #translationOptions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
        max-width: 400px;
        font-family: Arial, sans-serif;
      }
      label {
        font-weight: bold;
      }
      select, input[type="text"], button {
        padding: 8px;
        font-size: 1rem;
        border-radius: 5px;
        border: 1px solid #ccc;
        width: 100%;
      }
      #translateBtn {
        background-color: #4CAF50;
        color: white;
        cursor: pointer;
        border: none;
        font-weight: bold;
      }
      #translateBtn:hover {
        background-color: #45a049;
      }
      #translatedText {
        margin-top: 16px;
        padding: 10px;
        border-radius: 5px;
        background-color: #f2f2f2;
        min-height: 40px;
        white-space: pre-wrap;
      }
        body.dark-mode #modeInstructions {
          color: #ccc;
        }

        @font-face {
      font-family: 'Squartiqa 4F';
      src: url('/static/fonts/Squartiqa4F.woff2') format('woff2'),
           url('/static/fonts/Squartiqa4F.woff') format('woff'),
           url('/static/fonts/Squartiqa4F.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }

    .squartiqa {
      font-family: 'Squartiqa 4F', sans-serif;
    }

        #translationContainer {
  display: flex;
  justify-content: center; /* center horizontally */
  align-items: center;     /* center vertically */
  flex-direction: column;
  margin-top: 20px;        /* space from elements above */
}

#translationOptions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 400px;
  width: 100%;             /* ensures inputs fill container */
  font-family: Arial, sans-serif;
}
        
        #face {
  position: absolute;
  top: calc(50% - 80px);
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  pointer-events: none;
}

.smile {
  width: 32px;               
  height: 14px;              
  border-bottom: 3px solid white; 
  border-radius: 50% / 100%; /* soft curved smile */
  transform: rotate(0deg) translateX(0px); /* start upright and centered */
  opacity: 0;                 
  position: relative;
  box-shadow: 0 1px 2px rgba(255,255,255,0.5);
  animation: smileFadeTiltSlide 2s forwards 2.2s; /* fade, tilt, slide */
}

@keyframes smileFadeTiltSlide {
  0% {
    opacity: 0;
    transform: rotate(0deg) translateX(0px);
  }
  50% {
    opacity: 1;          /* fully visible before tilt/slide */
    transform: rotate(0deg) translateX(0px);
  }
  100% {
    opacity: 1;
    transform: rotate(-9deg) translateX(8px); /* tilt and move right */
  }
}

/* ===== GTA derived Wheel ===== */
#modeWheelContainer {
  position: relative;
  width: 300px;
  height: 300px;
  margin: 40px auto;
}

#modeWheel {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  position: relative;
  transform: rotate(-18deg); /* align first slice nicely */
}

.wheel-option {
  position: absolute;
  width: 100px;
  height: 40px;
  left: 50%;
  top: 50%;
  transform-origin: -50px 0; /* pivot at wheel center */
  text-align: center;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 8px;
  background: rgba(255,255,255,0.2);
  transition: transform 0.3s, background 0.3s, box-shadow 0.3s;
  user-select: none;
}

.wheel-option:hover {
  background: rgba(0, 150, 255, 0.8);
  color: white;
  box-shadow: 0 0 12px rgba(0, 150, 255, 0.7);
  transform: scale(1.2) rotate(var(--rotate)); /* keep rotation when scaling */
}

    </style>
</head>
<body>
<!-- ========== INTRO SCREEN ========== -->
<div id="introScreen" aria-label="Welcome Screen" role="dialog" aria-modal="true">
    <div id="face">
  <div class="eyes" aria-hidden="true">
    <div class="eye"></div>
    <div class="eye"></div>
  </div>

  <div class="smile"></div>
</div>
    <div id="introText">
    <div id="introLine1">Hello there, friend</div>
    <div id="introLine2">I'm <span class="squartiqa">WREN</span></div>

    <div id="orbitalWrapper" aria-hidden="true">
        <div id="introBall"></div>
    </div>
</div>
</div>

<!-- ========== MAIN APP ========== -->
<main role="main" aria-live="polite" style="display:none;">
    <h1 id="mainTitle">üëã Hello there ‚Äî I'm WREN</h1>



    <!-- Dark Mode Toggle -->
    <label for="darkModeToggle" id="darkModeLabel" style="user-select:none; margin-bottom: 10px; cursor:pointer;">
        <input type="checkbox" id="darkModeToggle"/> Toggle Dark Mode
    </label>


    <div id="startContainer" class="input-group">
        <label for="nameInput" id="nameLabel">üìù  Before continuing forward, please Enter your name!:</label>
        <input
                type="text"
                id="nameInput"
                placeholder="Your name here..."
                autocomplete="off"
                aria-describedby="nameLabel"
        />
        <button id="startBtn">
            <span class="icon">‚û§</span> Send
        </button>
    </div>



    <!-- ========== RESPONSE + VIDEO INFO ========== -->
    <div id="response" aria-live="polite"></div>
    <div id="video-info"></div>

    <!-- ========== MODE UI CONTAINER ========== -->
<div id="modeUIContainer">
    <section
        id="modeSection"
        aria-label="Mode Selection and Interaction"
        style="display: none;"
    >
        <div id="modeWheelContainer">
            <div id="modeWheel">
                <div class="wheel-option" data-value="1">ü§ñ Name Recognition</div>
                <div class="wheel-option" data-value="math">üßÆ Math Solver</div>
                <div class="wheel-option" data-value="science">üî¨ Science</div>
                <div class="wheel-option" data-value="book">üìö Book</div>
                <div class="wheel-option" data-value="budget">üí∞ Budget</div>
                <div class="wheel-option" data-value="depression">ü©∫ Depression</div>
                <div class="wheel-option" data-value="tidy">üè† Tidying</div>
                <div class="wheel-option" data-value="logs">üìú Logs</div>
                <div class="wheel-option" data-value="translate">üåê Translate</div>
                <div class="wheel-option" data-value="10">üìù Reminder</div>
            </div>
        </div>
    </section>
</div>

            <!-- Mode Instructions -->
            <div
                    id="modeInstructions"
                    aria-live="polite"
                    aria-atomic="true"
                    style="margin-top: 10px;"
            ></div>

            <!-- General Input Group -->
            <div id="modeTextInputGroup" class="input-group" style="display: none;">
                <label for="modeTextInput">Your input:</label>
                <input
                        type="text"
                        id="modeTextInput"
                        placeholder="Enter your question or info..."
                />
            </div>

            <!-- Query Input Group -->
            <div id="queryInputGroup" class="input-group" style="display: none;">
                <label for="user-input">Ask a question:</label>
                <input
                        type="text"
                        id="user-input"
                        placeholder="Ask a question..."
                        autocomplete="off"
                />
            </div>

            <!-- House Tidying Input Group -->
            <div id="tidyingInstructions" style="margin-top: 10px; display: none;">
                <label for="tidyingTopic" id="tidyingTopicLabel">
                    üè† What area would you like help tidying?
                    <span style="display: block; font-size: 0.9em; color: #666; margin-top: 4px;">
      Try one of these: <strong>cleaning</strong>, <strong>energy</strong>,
      <strong>security</strong>, <strong>organization</strong>,
      <strong>automation</strong>
    </span>
                </label>
                <input
                        type="text"
                        id="tidyingTopic"
                        placeholder="e.g., cleaning, organization, energy..."
                        autocomplete="off"
                        style="margin-top: 8px;"
                />
            </div>
        </section>
    </div>

    <div id="bookCategoryGroup" style="margin-top: 20px; display: none;">
        <label for="bookCategory" id="bookCategoryLabel">Choose a book category:</label>
        <select id="bookCategory" aria-describedby="bookCategoryLabel">
            <option value="">-- Select a Category --</option>
            <option value="fantasy">fantasy</option>
            <option value="science">science</option>
            <option value="adventure">adventure</option>
            <option value="romance">romance</option>
            <option value="comedy">comedy</option>
        </select>
    </div>

    <div id="bookTypeGroup" style="margin-top: 16px; display: none;">
        <label id="bookTypeLabel">What kind of recommendation do you want?</label><br/>
        <label><input type="radio" name="bookType" value="1"/> üìñ Book</label><br/>
        <label><input type="radio" name="bookType" value="2"/> üéß Audiobook/Video</label><br/>
        <label><input type="radio" name="bookType" value="3" checked/> üìö + üéß Both</label>
    </div>


    <div id="translationContainer">
  <div id="translationOptions" style="display: none; flex-direction: column; gap: 12px; margin-top: 20px; max-width: 400px;">
    <label for="textToTranslate">Enter text to translate:</label>
    <textarea id="textToTranslate" placeholder="Type your text here..." rows="4" style="width: 100%;"></textarea>

    <label for="translateTo">Translate to:</label>
    <select id="translateTo" style="width: 100%;"></select>

    <button id="translateBtn" style="padding: 8px 12px; cursor: pointer;">Translate</button>

    <!-- Loading + Output -->
    <div id="loadingIndicator" style="display: none; color: #555;">üîÑ Translating...</div>
    <div id="translatedText" style="margin-top: 10px; white-space: pre-wrap; font-weight: bold;"></div>
  </div>
</div>

    <div id="budgetChatContainer"
         style="display:none; border: 1px solid #2b6be6; padding: 10px; height: 300px; overflow-y: auto; margin-top: 20px; background: #f9f9f9;">
        <div id="finalScoreDisplay" style="display: none; font-weight: bold; margin-top: 10px;"></div>
    </div>


    <button id="sendBtn" style="display:none; margin-top: 20px;">Send</button>

    <div id="output" style="white-space: pre-wrap; margin-top: 20px;"></div>

    <div id="modeResponse" aria-live="polite" aria-atomic="true" style="margin-top: 20px;"></div>


</main>

<script>
    let currentUserId = null;
    let userInput = '';
    let depressionStep = 0;
    let depressionAnswers = [];





    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('change', () => {
      document.body.classList.toggle('dark-mode', darkModeToggle.checked);
    });

    // Elements
    const startBtn = document.getElementById('startBtn');
    const responseDiv = document.getElementById('response');
    const modeSection = document.getElementById('modeSection');
    const sendBtn = document.getElementById('sendBtn');
    const modeResponse = document.getElementById('modeResponse');
    const nameInput = document.getElementById('nameInput');
    const bookCategoryGroup = document.getElementById('bookCategoryGroup');
    const bookCategorySelect = document.getElementById('bookCategory');
    const bookTypeGroup = document.getElementById('bookTypeGroup');
    const modeInstructions = document.getElementById('modeInstructions');
    const translationOptions = document.getElementById('translationOptions');
    const voiceBtn = document.getElementById('voiceBtn');
    const voiceResponse = document.getElementById('voiceResponse');
    const wheelOptions = document.querySelectorAll('.wheel-option');
    const modeTextInput = document.getElementById('modeTextInput');

    async function startSession(username) {
  try {
    const response = await fetch('/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: username }),
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'Failed to start session.');
    }

    // Store the userId (which is the sanitized name from backend)
    localStorage.setItem('userId', data.userId);
    return data.userId;
  } catch (error) {
    alert('Error starting session: ' + error.message);
    return null;
  }
}



function fetchLogs() {
  fetch('/logs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId: currentUserId })
  })
  .then(res => res.json())
  .then(data => {
    if (data.logs && Array.isArray(data.logs)) {
      const logHtml = data.logs.map(entry => `
        <div style="margin-bottom: 12px;">
          <strong>[${entry.timestamp}]</strong><br>
          <strong>You:</strong> ${entry.question}<br>
          <strong>WREN:</strong> ${entry.response}<br>
          <em>Emotion:</em> ${entry.emotion}<br>
          ${entry.tags?.length ? `<em>Tags:</em> ${entry.tags.join(', ')}` : ''}
          ${entry.belief_tags?.length ? `<br><em>Beliefs:</em> ${entry.belief_tags.join(', ')}` : ''}
        </div>
        <hr>
      `).join('');

      modeResponse.innerHTML = logHtml;
    } else {
      modeResponse.textContent = '‚ö†Ô∏è No memory logs found.';
    }
  })
  .catch(err => {
    console.error('[logs fetch error]', err);
    modeResponse.textContent = '‚ö†Ô∏è Error retrieving memory logs.';
  });
}

window.addEventListener("load", () => {
    const wrapper = document.getElementById("orbitalWrapper");
    const ball = document.getElementById("introBall");

    // Step 1: appear
    ball.style.opacity = "0";
    ball.style.transition = "opacity 0.6s ease";

    setTimeout(() => {
        ball.style.opacity = "1";
    }, 300);

    // Step 2: orbit
    setTimeout(() => {
        wrapper.style.animation = "orbitText 2.5s ease-in-out forwards";
    }, 900);

    // Step 3: return to original spot
    setTimeout(() => {
        wrapper.style.animation = "none";
        wrapper.style.transform = "rotate(0deg)";
    }, 3500);
});


window.addEventListener('DOMContentLoaded', () => {
  const wheelItems = document.querySelectorAll('.wheel-option');
  if (!wheelItems.length) return console.warn("No wheel items found.");

  const sendBtn = document.getElementById('sendBtn');
  sendBtn.disabled = true; // disable send until a mode is selected

  function highlightSelectedWheelItem(selectedItem) {
    wheelItems.forEach(item => item.classList.remove('selected-wheel'));
    selectedItem.classList.add('selected-wheel');

    const selectedAngle = parseFloat(selectedItem.style.getPropertyValue('--rotate')) || 0;
    const wheel = document.getElementById('modeWheel');
    if (wheel) wheel.style.transform = `rotate(${-selectedAngle}deg)`;
  }

  const total = wheelItems.length;
  const angleStep = 360 / total;

  wheelItems.forEach((item, i) => {
    const angle = i * angleStep;
    item.style.setProperty('--rotate', `${angle}deg`);
    item.style.transform = `rotate(${angle}deg) translate(100px) rotate(-${angle}deg)`;

    item.addEventListener('click', () => {
      const modeValue = item.dataset.value; // correctly scoped

      // Store globally
      window.currentSelectedMode = modeValue;

      // Update the UI for selected mode
      updateModeUI(modeValue);

      // Highlight the clicked wheel item
      highlightSelectedWheelItem(item);

      // Enable send button now that a mode is selected
      sendBtn.disabled = false;
    });
  });
});

window.addEventListener('load', async () => {
  // You need to define username here or fetch it from somewhere
  // For example, from an input or localStorage:
  const username = localStorage.getItem('username') || ''; // or get from input

  if (username) {
    const userId = await startSession(username);
    if (!userId) {
      // handle error if session didn't start properly
      return;
    }
  }

  const intro = document.getElementById('introScreen');
  const main = document.querySelector('main');

  setTimeout(() => {
    intro.classList.add('fade-out');
    intro.addEventListener(
      'transitionend',
      () => {
        intro.style.display = 'none';
        main.style.display = 'block';
        requestAnimationFrame(() => {
          main.classList.add('fade-in');
          document.getElementById('nameInput').focus();
        });
      },
      { once: true }
    );
  }, 9000);
});


    const languages = {
  en: "English",
  es: "Spanish",
  fr: "French",
  de: "German",
  zh: "Chinese",
  ja: "Japanese",
  ru: "Russian",
  ar: "Arabic",
  hi: "Hindi"
};

const translateTo = document.getElementById('translateTo');
const textToTranslate = document.getElementById('textToTranslate');
const translatedText = document.getElementById('translatedText');
const loadingIndicator = document.getElementById('loadingIndicator');
const translateBtn = document.getElementById('translateBtn');

// Populate the target language dropdown
function populateTranslateTo() {
  for (const [code, name] of Object.entries(languages)) {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = name;
    translateTo.appendChild(option);
  }
  translateTo.value = 'en'; // default
}
populateTranslateTo();

// Translate button click
translateBtn.addEventListener('click', async () => {
  const text = textToTranslate.value.trim();
  if (!text) return alert("Please enter some text to translate.");

  const target_lang = translateTo.value;
  translatedText.textContent = '';
  loadingIndicator.style.display = 'block';

  try {
    const response = await fetch('/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        mode: 'translate',
        input: text,
        user_translate: true,
        ai_translate: false,
        target_lang: target_lang,
        source_lang: 'auto',  // always auto-detect
      }),
    });
    const data = await response.json();
    translatedText.textContent = data.translated_input || 'Translation failed.';
  } catch (err) {
    translatedText.textContent = 'Network error: ' + err.message;
  } finally {
    loadingIndicator.style.display = 'none';
  }
});



async function ensureSession(userId) {
  const response = await fetch('/create_session', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ userId }),
  });
  const data = await response.json();
  if (!data.success) {
    alert('Failed to create user session: ' + (data.error || 'Unknown error'));
  }
}

async function startApp() {
    const userId = localStorage.getItem('userId') || prompt("Enter your username:");
    if (!userId) {
      alert("Username is required!");
      return;
    }

    localStorage.setItem('userId', userId);
    await ensureSession(userId);
  }

  document.addEventListener('DOMContentLoaded', startApp);



    function updateDepressionScoreDisplay() {
  const scoreDiv = document.getElementById('finalScoreDisplay');
  if (!scoreDiv) return;

  if (depressionScore > 0) {
    scoreDiv.textContent = `üß† Screening Score: ${depressionScore}`;
    scoreDiv.style.display = 'block';
  } else {
    scoreDiv.style.display = 'none';
  }
}




    // Update UI based on mode selection
    function updateModeUI(selected) {
    if (!selected) return;

    const modeSection = document.getElementById('modeSection');
    const queryInputGroup = document.getElementById('queryInputGroup');
    const modeTextInputGroup = document.getElementById('modeTextInputGroup');
    const chatContainer = document.getElementById('budgetChatContainer');

    // Reset UI elements
    sendBtn.style.display = 'inline-block';
    modeSection.style.display = selected ? 'block' : 'none';
    chatContainer.style.display = selected === 'budget' ? 'block' : 'none';
    queryInputGroup.style.display = 'none';
    modeTextInputGroup.style.display = 'none';
    bookCategoryGroup.style.display = 'none';
    bookTypeGroup.style.display = 'none';
    translationOptions.style.display = 'none';
    modeInstructions.textContent = '';
    modeResponse.textContent = '';

  switch (selected) {
    case 'math':
    case 'science':
      queryInputGroup.style.display = 'block';
      modeInstructions.textContent = `Enter your ${selected === 'math' ? 'math problem' : 'science question'} above and click Send.`;
      break;

    case 'tidy':
      // No queryInputGroup or modeTextInputGroup shown here
      modeInstructions.innerHTML = `
        <label for="tidyingTopic">
          üè† What area would you like help tidying?
          <span style="display: block; font-size: 0.9em; color: #808080; margin-top: 4px;">
            Try one of these: <strong>cleaning</strong>, <strong>energy</strong>,
            <strong>security</strong>, <strong>organization</strong>,
            <strong>automation</strong>
          </span>
        </label>
        <input
          type="text"
          id="tidyingTopic"
          placeholder="e.g., cleaning, organization, energy..."
          autocomplete="off"
          style="margin-top: 8px;"
        />
      `;
      break;

    case 'book':
      bookCategoryGroup.style.display = 'block';
      bookTypeGroup.style.display = 'block';
      modeInstructions.textContent = 'Select a book category and type, then click Send.';
      break;

    case 'depression':
      modeTextInputGroup.style.display = 'none';
      modeResponse.style.display = 'block';
      modeInstructions.textContent = 'Hello friend! Press "Send" to begin the depression screening.';
      modeTextInput.style.display = 'block';
      modeTextInput.focus();

      fetch('/mode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: currentUserId, mode: 'depression', input: '' })
      })
      .then(res => res.json())
      .then(data => {
        if (data && data.response) {
          if (typeof data.score === 'number') {
            depressionScore = data.score;
            updateDepressionScoreDisplay();
          }
          modeResponse.innerHTML = data.response.replace(/\n/g, '<br>');
        }
      })
      .catch(() => {});
      break;


    case 'translate':
      translationOptions.style.display = 'flex';
      modeInstructions.textContent = 'Enter your text and choose the target language.';
      sendBtn.style.display = 'none';            // hide the normal send button
      document.getElementById('translateBtn').style.display = 'inline-block'; // show translate button
      break;

    case 'budget':
      modeTextInputGroup.style.display = 'block';
      modeInstructions.textContent = 'Enter your savings goal and click Send.';
      chatContainer.innerHTML = '';

      // Show bot typing indicator
      const botMessage = document.createElement('div');
      botMessage.textContent = 'WREN is typing...';
      botMessage.style.fontStyle = 'italic';
      chatContainer.appendChild(botMessage);

      fetch('/mode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: currentUserId, mode: 'budget', input: '' }),
      })
      .then(res => res.json())
      .then(data => {
        chatContainer.removeChild(botMessage);
        if (data && typeof data.response === 'string' && data.response.trim() !== '') {
          const botReply = document.createElement('div');
          botReply.innerHTML = typeof markdownToHtml === 'function'
            ? markdownToHtml(data.response)
            : data.response;
          chatContainer.appendChild(botReply);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      })
      .catch(error => {
        console.error('Budget welcome error:', error);
        chatContainer.removeChild(botMessage);
        const errorDiv = document.createElement('div');
        errorDiv.textContent = '‚ùå Failed to load budget intro.';
        chatContainer.appendChild(errorDiv);
      });
      break;

    case '1': // Name Recognition
      modeTextInputGroup.style.display = 'block';
      modeInstructions.textContent = 'Enter your name and click Send.';
      break;

    case 'logs':
      modeTextInputGroup.style.display = 'none';
      queryInputGroup.style.display = 'none';
      modeInstructions.textContent = 'üìú Displaying your memory log...';
      modeResponse.textContent = 'Loading...';
      fetchLogs();
      break;

    case '10': // Reminder mode (number or string)
    case 'reminder':
      modeTextInputGroup.style.display = 'block';
      queryInputGroup.style.display = 'none';
      chatContainer.style.display = 'none'; // hide budget container if shown previously

      modeInstructions.innerHTML = `
        üìù <strong>Task Reminder Mode</strong><br><br>
        Use commands like:
        <ul style="margin-top: 4px; padding-left: 20px; font-size: 0.95em;">
          <li><code>add Call mom at 5pm</code></li>
          <li><code>view</code></li>
          <li><code>check_due</code></li>
          <li><code>clear</code></li>
        </ul>
        Enter your command below and click <strong>Send</strong>.
      `;
      modeResponse.textContent = '';
      break;

    default:
      modeInstructions.textContent = 'Please enter your input and click Send.';
      sendBtn.style.display = 'inline-block';
      break;
  }
}



   startBtn.addEventListener("click", async () => {
  const name = nameInput.value.trim();

  if (!name) {
    responseDiv.innerText = "‚ö†Ô∏è Please enter your name first.";
    return;
  }

  try {
    // Send name to backend to start session or register user
    const response = await fetch("/start", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ name })
    });

    const result = await response.json();

    if (result.success) {
      currentUserId = result.userId;

      responseDiv.innerText = result.response || `üëã Hello, ${name}! Please interact below to see what I can do for you!`;

      // Show mode selection section, focus input
      modeSection.style.display = 'block';
      document.getElementById('modeWheelContainer').scrollIntoView({ behavior: 'smooth' });

      // Disable start inputs & button to prevent re-submission
      startBtn.disabled = true;
      nameInput.disabled = true;

      // Show send button for further interactions
      sendBtn.style.display = 'inline-block';
    } else {
      responseDiv.innerText = `‚ùå ${result.error || 'Unknown error'}`;
    }
  } catch (error) {
    console.error("Error:", error);
    responseDiv.innerText = "‚ùå Something went wrong. Try again.";
  }
});

    sendBtn.addEventListener('click', async () => {
  const mode = window.currentSelectedMode; // use wheel-selected mode
  if (!validateMode(mode)) return;
  if (!validateSession()) return;

  try {
    sendBtn.disabled = true;
    modeResponse.textContent = '‚è≥ Processing...';

    switch (mode) {
      case '1':
        await handleNameRecognition();
        break;
      case 'book':
        await handleBookMode();
        break;
      case 'budget':
        await handleBudgetMode();
        break;
      case 'logs':
        await fetchLogs();
        break;
      case 'depression':
        await handleDepressionMode();
        break;
      case 'tidy':
        await handleTidyMode();
        break;
      case 'translate':
        await handleTranslateMode();
        break;
      case 'voice':
        console.warn('Voice mode is not yet implemented.');
        modeResponse.textContent = 'üõë Voice mode is currently unavailable.';
        break;
      case 'reminder':
      case '10':
        await handleReminderMode();
        break;
      case 'science':
      case 'math':
        await handleGenericMode(mode);
        break;

      default:
        modeResponse.textContent = `‚ö†Ô∏è Unknown mode: ${mode}`;
        break;
    }
  } catch (err) {
    console.error('Error in mode handler:', err);
    modeResponse.textContent = `‚ùå ${err.message || 'Unexpected error.'}`;
  } finally {
    sendBtn.disabled = false;
  }
});


// ======= VALIDATION HELPERS =======
function validateMode(mode) {
  if (!mode) {
    modeResponse.textContent = '‚ö†Ô∏è Please select a mode.';
    return false;
  }
  return true;
}

function validateSession() {
  if (!currentUserId) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter your name and start first.';
    return false;
  }
  return true;
}

// ======= SHARED UTILS =======
async function postMode(payload) {
  const res = await fetch('/mode', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return res.json();
}

function markdownToHtml(markdown = '') {
  // Links: [text](url)
  let html = markdown.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

  // Bold
  html = html.replace(/(?:\*\*|__)(.*?)\1/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/(?:\*|_)(.*?)\1/g, '<em>$1</em>');
  // Numbered list items
  html = html.replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>');

  // Wrap consecutive <li> in <ol>
  html = html.replace(/(?:<li>.*?<\/li>\s*)+/gs, match => `<ol>${match}</ol>`);

  // Replace remaining newlines with <br>
  html = html.replace(/\n/g, '<br>');

  return html;
}

// =========== Depression Mode ===========
async function handleDepressionMode() {
  // Clear previous error messages
  modeResponse.querySelectorAll('.error-message').forEach(el => el.remove());

  // Show typing indicator
  const wrenMessage = document.createElement('p');
  wrenMessage.classList.add('processing-message');
  wrenMessage.innerHTML = `<em>‚è≥ Processing...</em>`;
  modeResponse.appendChild(wrenMessage);
  modeResponse.scrollTop = modeResponse.scrollHeight;

  try {
    // Send request to backend
    const payload = {
      userId: currentUserId,
      mode: 'depression',
      step: depressionStep,
      answers: depressionAnswers,
      answer: null // no input needed, just click Send
    };

    const data = await postMode(payload);
    wrenMessage.remove();

    // Update step and answers from backend
    depressionStep = data.next_step ?? depressionStep;
    depressionAnswers = data.answers ?? depressionAnswers;

    // Display backend message (questions, encouragement, or final score)
    if (data.message?.trim()) {
      const backendMessage = document.createElement('p');
      backendMessage.innerHTML = data.message.replace(/\n/g, '<br>');
      modeResponse.appendChild(backendMessage);
    }

    if (data.done) {
      // Screening complete
      depressionStep = 0;
      depressionAnswers = [];

      // Hide input when finished
      modeTextInput.style.display = 'none';
    } else {
      // Show input box for next click
      modeTextInput.style.display = 'block';
      modeTextInput.focus();
    }

  } catch (err) {
    wrenMessage.remove();
    const errorElem = document.createElement('p');
    errorElem.classList.add('error-message');
    errorElem.innerHTML = `‚ùå Error: ${err.message}`;
    modeResponse.appendChild(errorElem);
  } finally {
    modeResponse.scrollTop = modeResponse.scrollHeight;
  }
}

// ============== Task reminder =============
async function handleReminderMode() {
  const input = modeTextInput.value.trim(); // Get input from the text box

  if (!input) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter a reminder command.';
    return;
  }

  try {
    sendBtn.disabled = true;
    modeResponse.textContent = '‚è≥ Processing your reminder...';

    // Prepare payload to match your backend
    const payload = {
      userId: currentUserId,  // your user ID variable
      mode: 'reminder',
      input
    };

    const response = await fetch('/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (data && data.success) {
      // Render line breaks nicely
      modeResponse.innerHTML = `<strong>üìù Reminder Mode:</strong><br>${data.response.replace(/\n/g, '<br>')}`;
    } else if (data && data.error) {
      modeResponse.textContent = `‚ö†Ô∏è ${data.error}`;
    } else {
      modeResponse.textContent = '‚ö†Ô∏è Unexpected response. Try again!';
    }
  } catch (err) {
    console.error('Reminder mode error:', err);
    modeResponse.textContent = '‚ùå Failed to process your reminder. Check your network.';
  } finally {
    sendBtn.disabled = false;
  }
}
// ---- Book Reccomender mode -----
async function handleBookMode() {
  const topic = modeTextInput.value?.trim() || '';
  const category = bookCategorySelect?.value || '';
  const choice = document.querySelector('input[name="bookChoice"]:checked')?.value || '3';

  if (!topic && !category) {
    modeResponse.textContent = 'üìö Oops! Pick a category or enter a topic to start your adventure.';
    return;
  }

  try {
    sendBtn.disabled = true;
    modeResponse.textContent = '‚ú® Scouting the perfect story for you...';

    const payload = {
      userId: currentUserId,
      mode: 'book',
      topic,
      category,
      choice
    };

    const data = await postMode(payload);

    let output = '';

    // --- Book Recommendation ---
    if (data.book) {
      const bookUrl = data.book.url || '#';
      output += `üìò <strong>Book Recommendation:</strong><br>`;
      output += `üåü <a href="${bookUrl}" target="_blank" rel="noopener noreferrer">"${data.book.title}"</a><br>`;
      output += `‚úçÔ∏è Author: ${data.book.author}<br><br>`;
    }

    // --- Audiobook Picks ---
    if (Array.isArray(data.audiobooks) && data.audiobooks.length > 0) {
      output += `üéß <strong>Audiobook Picks:</strong><br>`;
      data.audiobooks.forEach((v, i) => {
        output += `üîπ <a href="${v.url}" target="_blank" rel="noopener noreferrer">${v.title}</a><br>`;
      });
      output += '<br>';
    }

    if (!output) {
      output = 'üòï No magical stories found this time. Try a different category!';
    }

    modeResponse.innerHTML = output; // we‚Äôre already using HTML tags, so no need for markdown here
  } catch (err) {
    console.error('Book mode error:', err);
    modeResponse.textContent = `‚ùå Oops! Something went wrong: ${err.message || 'Failed to fetch recommendations.'}`;
  } finally {
    sendBtn.disabled = false;
  }
}

// ---- TIDY ----
async function handleTidyMode() {
  const topic = document.getElementById('tidyingTopic')?.value.trim();
  if (!topic) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter a tidying topic.';
    return;
  }

  modeResponse.textContent = 'Tidying up...';
  const data = await postMode({
    userId: currentUserId,
    mode: 'tidy',
    input: topic
  });

  modeResponse.innerHTML = data?.response?.replace(/\n/g, '<br>') || '‚ö†Ô∏è No response received.';
}

// ---- BUDGET ----
async function handleBudgetMode() {
  const input = document.getElementById('modeTextInput').value.trim();
  if (!input) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter your input above.';
    return;
  }

  const chatContainer = document.getElementById('budgetChatContainer');
  appendChat(chatContainer, `You: ${input}`, true);
  document.getElementById('modeTextInput').value = '';

  const typingMsg = appendChat(chatContainer, 'WREN is typing...', false, true);
  const payload = { userId: currentUserId, mode: 'budget', input };

  try {
    const data = await postMode(payload);
    chatContainer.removeChild(typingMsg);

    if (!data || data.success === false) {
      appendChat(chatContainer, `‚ö†Ô∏è ${data?.error || 'Request failed.'}`);
    } else if (data.response?.trim()) {
      appendChat(chatContainer, markdownToHtml(data.response));
    } else {
      appendChat(chatContainer, '‚ö†Ô∏è No response from backend.');
    }
  } catch (err) {
    chatContainer.removeChild(typingMsg);
    appendChat(chatContainer, `‚ùå Error: ${err.message}`);
  }
}

function appendChat(container, text, isUser = false, italic = false) {
  const div = document.createElement('div');
  div.innerHTML = text;
  div.style.marginBottom = '8px';
  if (isUser) div.style.fontWeight = 'bold';
  if (italic) div.style.fontStyle = 'italic';
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

// ---- TRANSLATE ----
document.getElementById('translateBtn')?.addEventListener('click', handleTranslateMode);
async function handleTranslateMode() {
  // Get DOM elements
  const targetLang = document.getElementById('translateTo')?.value || 'en';
  const inputText = document.getElementById('textToTranslate')?.value.trim();
  const outputDiv = document.getElementById('translatedText');
  const loadingIndicator = document.getElementById('loadingIndicator');

  if (!inputText) {
    outputDiv.textContent = '‚ö†Ô∏è Please enter text to translate.';
    return;
  }

  // Show loading indicator
  if (loadingIndicator) loadingIndicator.style.display = 'block';
  outputDiv.textContent = '';

  // Use currentUserId or prompt if missing
  let userId = currentUserId || localStorage.getItem('userId');
  if (!userId) {
    userId = prompt('Enter your username:');
    if (!userId) {
      outputDiv.textContent = '‚ö†Ô∏è Username is required!';
      if (loadingIndicator) loadingIndicator.style.display = 'none';
      return;
    }
    localStorage.setItem('userId', userId);
    currentUserId = userId;
  }

  const payload = {
    userId: userId,
    mode: 'translate',
    input: inputText,
    user_translate: true,
    ai_translate: false,
    target_lang: targetLang,
    memory_logger: null
  };

  try {
    const response = await fetch('/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (data.success) {
      outputDiv.textContent = data.translated_input || '‚úÖ Translation complete.';
    } else {
      outputDiv.textContent = '‚ùå Translation failed: ' + (data.error || 'Unknown error.');
    }
  } catch (err) {
    console.error(err);
    outputDiv.textContent = '‚ùå Translation failed. Please try again.';
  } finally {
    if (loadingIndicator) loadingIndicator.style.display = 'none';
  }
}

// ---- Name Recognition Mode with Last Interaction Teaser ----
async function handleNameRecognition() {
  const name = modeTextInput.value?.trim();

  if (!name) {
    modeResponse.textContent = 'üôã‚Äç‚ôÇÔ∏è Please enter your name to get started!';
    return;
  }

  try {
    sendBtn.disabled = true;
    modeResponse.textContent = '‚ú® Recognizing you...';

    const payload = {
      userId: currentUserId,
      mode: '1',        // corresponds to handle_mode_1 in your backend
      input: name
    };

    const data = await postMode(payload);

    if (data?.response) {
      let displayText = data.response;

      // If last topic is included in the response, highlight it
      displayText = displayText.replace(
        /(Last time we worked on .*?\.)/i,
        '<span style="color:#ffdd57;font-weight:bold;">$1</span>'
      );

      modeResponse.innerHTML = `
        üéâ <strong>Welcome, ${name}!</strong><br><br>
        ${displayText}
      `;

      // Optional: add a fun emoji depending on time of day
      const hour = new Date().getHours();
      let emoji = 'üåû';
      if (hour >= 17) emoji = 'üåô';
      else if (hour >= 12) emoji = '‚òÄÔ∏è';

      modeResponse.innerHTML += `<br>${emoji} Let's dive in!`;
    } else {
      modeResponse.textContent = 'üòÖ Hmm, something went wrong recognizing your name.';
    }

  } catch (err) {
    console.error('Name recognition error:', err);
    modeResponse.textContent = `‚ùå Error: ${err.message || 'Failed to process your name.'}`;
  } finally {
    sendBtn.disabled = false;
  }
}

// ---- GENERIC / FALLBACK DEBUG-SAFE ----
async function handleGenericMode(mode) {
  // Determine input element based on mode
  const inputElement =
    mode === 'math' || mode === 'science'
      ? document.getElementById('user-input')
      : document.getElementById('modeTextInput');

  if (!inputElement) {
    console.error(`[handleGenericMode] Input element not found for mode: ${mode}`);
    modeResponse.innerHTML = `‚ö†Ô∏è Input field not found for mode: ${mode}`;
    return;
  }

  const input = inputElement.value.trim();
  if (!input) {
    console.warn(`[handleGenericMode] Empty input for mode: ${mode}`);
    modeResponse.innerHTML = '‚ö†Ô∏è Please enter something before sending.';
    return;
  }

  if (!currentUserId) {
    console.error('[handleGenericMode] currentUserId is undefined!');
    modeResponse.innerHTML = '‚ö†Ô∏è User not logged in. Please start a session first.';
    return;
  }

  const payload = { userId: currentUserId, mode, input };
  console.log('[handleGenericMode] Payload being sent:', payload);

  try {
    const res = await fetch('/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    // --- Separate parsing for math (JSON) vs science (text) ---
    let data;
    if (mode === 'science') {
      // Text-only mode for science
      const textResponse = await res.text();
      data = { response: textResponse };
    } else {
      // JSON mode for math (or other structured responses)
      data = await res.json();
    }

    console.log('[handleGenericMode] Backend response:', data);

    if (!res.ok) {
      const errorMsg = data?.error || `HTTP ${res.status} ${res.statusText}`;
      throw new Error(errorMsg);
    }

    // Get the response string
    const fullResponse = data.response?.trim() || '‚ö†Ô∏è No answer received.';

    // Convert markdown to HTML and show
    const formattedHtml = markdownToHtml(fullResponse);
    modeResponse.innerHTML = formattedHtml;

    // Re-render mathjax if needed
    if (window.MathJax) {
      MathJax.typesetPromise();
    }

  } catch (err) {
    console.error('[handleGenericMode] Error:', err);
    modeResponse.innerHTML = `‚ö†Ô∏è Error: ${err.message}`;
  }
}

// ======= KEEP YOUR EXISTING DOMContentLoaded LOGIC BELOW =======
document.addEventListener('DOMContentLoaded', () => {
  // Existing book category fetch, start session, etc.
  const bookCategoryDropdown = document.getElementById('bookCategory');
  if (bookCategoryDropdown) {
    fetch('/api/book-categories')
      .then(response => response.json())
      .then(categories => {
        bookCategoryDropdown.innerHTML = '<option value="">-- Select a Category --</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.toLowerCase();
          option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
          bookCategoryDropdown.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Failed to load book categories:', error);
        bookCategoryDropdown.innerHTML = '<option value="">‚ö†Ô∏è Failed to load</option>';
      });
  }

  const startSessionBtn = document.getElementById('startSessionBtn');
  const usernameInput = document.getElementById('usernameInput');

  if (startSessionBtn && usernameInput) {
    startSessionBtn.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      if (!username) {
        alert('Please enter your name.');
        return;
      }

      const userId = await startSession(username);
      if (userId) {
        alert(`Session started for ${username}`);
        localStorage.setItem('userId', userId);
      }
    });
  }
});



</script>

<style>



    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background: white;
      color: #333;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-mode {
      background-color: #121212;
      color: #eee;
    }

    .fade-out {
      opacity: 0;
      transition: opacity 1s ease-out;
    }

    .fade-in {
      opacity: 1;
      transition: opacity 1s ease-in;
    }

    #introScreen {
      text-align: center;
      margin-top: 100px;
      font-size: 1.5rem;
    }

    #introStar {
      margin-top: 20px;
      fill: #1e88e5;
    }

    label {
      font-weight: bold;
    }

    input[type="text"], select {
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 10px;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 4px;
    }

    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    a {
      color: #1e88e5;
    }

    a:hover {
      text-decoration: underline;
    }
</style>
</body>
