<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>WREN AI Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet"/>
    <style>
        /* ===== Global Styles ===== */



        #startContainer {
      max-width: 320px;
      margin: 40px auto 30px auto; /* centers horizontally and adds vertical spacing */
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px; /* space between elements */
    }

    #startContainer label {
      font-weight: 600;
      font-size: 1rem;
      color: #444;
      user-select: none;
      text-align: center;
      width: 100%;
    }

        html, body {
          margin: 0; padding: 0;
          font-family: 'Quicksand', sans-serif;
          background: #f9f9f9;
          height: 100%;
          color: #333;
          transition: background-color 0.5s ease, color 0.5s ease;
          user-select: none;
        }
        body.dark-mode {
          background: #121212;
          color: #ddd;
        }
        body.dark-mode main {
          background: linear-gradient(to right, #222, #333);
          color: #eee;
          box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

             #video-info {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.6s ease, transform 0.6s ease;
      pointer-events: none;
    }

    #video-info.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    body.dark-mode #video-info {
      background: #1e1e1e;
      color: #ddd;
    }

        /* ===== Intro Screen ===== */
        #introScreen {
          position: fixed;
          z-index: 9999;
          top: 0; left: 0;
          width: 100vw; height: 100vh;
          background: black;
          color: white;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          transition: opacity 1.5s ease;
        }
        #introScreen.fade-out {
          opacity: 0 !important;
          pointer-events: none;
        }
        .eyes {
          position: absolute;
          top: calc(50% - 80px);
          left: 50%;
          transform: translateX(-50%);
          display: flex;
          gap: 24px;
          animation: fadeIn 2s forwards 1.5s;
          pointer-events: none;
          width: 80px;
          justify-content: center;
        }
        .eye {
          width: 20px; height: 20px;
          background: white;
          border-radius: 50%;
          animation: blink 4s infinite;
        }
        .eye:nth-child(2) {
          animation-delay: 2s;
        }
        @keyframes blink {
          0%, 90%, 100% { height: 20px; }
          95% { height: 2px; }
        }

        #introText {
          text-align: center;
          position: relative;
          margin-top: 40px;
        }
        #introLine1 {
          font-size: 1.4rem;
          margin: 0 0 8px 0;
          opacity: 0;
          animation: fadeIn 2s forwards 0.5s;
          line-height: 1.2;
          font-weight: 400;
          color: #ccc;
        }
        #introLine2 {
          font-size: 2.2rem;
          font-weight: 900;
          color: white;
          text-shadow: 0 0 5px white, 0 0 10px white, 0 0 20px white, 0 0 30px white;
          opacity: 0;
          animation: fadeIn 2s forwards 2.5s, wrenGlow 3s infinite ease-in-out 4.5s;
          line-height: 1.1;
          letter-spacing: 0.06em;
        }
        #introStar {
          display: block;
          margin: 20px auto 0;
          width: 60px; height: 60px;
          opacity: 0;
          animation: fadeIn 2s forwards 3.5s, starPulse 3s infinite ease-in-out 5s;
        }
        @keyframes starPulse {
          0%, 100% { fill: #1e88e5; opacity: 1; }
          50% { fill: #1e88e5; opacity: 0.7; }
        }
        @keyframes wrenGlow {
          0%, 100% {
            text-shadow: 0 0 5px white, 0 0 10px white, 0 0 20px white, 0 0 30px white;
            color: white;
          }
          50% {
            text-shadow: 0 0 2px white, 0 0 6px white, 0 0 10px white;
            color: white;
          }
        }
        @keyframes fadeIn {
          to { opacity: 1; }
        }

    .fade-in {
      opacity: 0;
      animation: fadeInMain 1.5s forwards;
    }

    @keyframes fadeInMain {
      to {
        opacity: 1;
      }
    }

        /* ===== Main App Styles ===== */
        main {
          display: none;
          max-width: 700px;
          margin: 40px auto 60px auto;
          padding: 30px 25px;
          background: linear-gradient(to right, #e3f2fd, #fbe9e7);
          border-radius: 16px;
          box-shadow: 0 0 20px rgba(0,0,0,0.1);
          color: #333;
          box-sizing: border-box;
          min-height: 300px;
          transition: background 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
        }
        h1 {
          text-align: center;
          color: #2c3e50;
          margin-bottom: 25px;
          user-select: none;
        }
        label {
          margin-top: 18px;
          display: block;
          font-weight: 600;
          font-size: 1rem;
          color: #444;
          user-select: none;
        }
        input, select {
          padding: 12px 15px;
          margin-top: 8px;
          width: 100%;
          font-size: 1rem;
          border: 1px solid #ccc;
          border-radius: 8px;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
          background: white;
          color: #333;
        }
        input:focus, select:focus {
          outline: none;
          border-color: #4caf50;
          box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
        }
        button {
          padding: 14px 0;
          font-size: 1.1rem;
          width: 100%;
          margin-top: 22px;
          background-color: #4caf50;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          transition: background-color 0.3s ease;
          user-select: none;
        }
        button:hover:not(:disabled) {
          background-color: #388e3c;
        }
        button:disabled {
          background-color: #a5d6a7;
          cursor: wait;
        }
        #response, #modeResponse {
          margin-top: 22px;
          background: #fff;
          padding: 20px;
          border-radius: 12px;
          box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
          font-size: 1rem;
          color: #222;
          user-select: text;
          transition: background 0.5s ease, color 0.5s ease;


          white-space: pre-wrap;        /* Preserve line breaks and wrap lines */
          word-wrap: break-word;        /* Break long words if needed */
          overflow-y: auto;             /* Allow scrolling if content is tall */
          max-height: 350px;            /* Limit height so it doesn‚Äôt take over the screen */
          font-family: monospace
        }
        #modeSection {
          display: none;
          margin-top: 32px;
        }
        #bookCategoryGroup {
          display: none;
          margin-top: 18px;
        }

        #modeUIContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 32px;
    }

    #modeSection {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    #modeTextInput,
    #user-input {
      width: 300px;
      max-width: 90%;
      margin-top: 8px;
    }

    #modeTextInputGroup,
    #queryInputGroup {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

        #modeInstructions {
          margin-top: 8px;
          font-size: 0.9rem;
          color: #555;
          min-height: 10em;
          font-style: italic;
          white-space: pre-wrap;
          transition: color 0.5s ease;
        }
        #translationOptions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
        max-width: 400px;
        font-family: Arial, sans-serif;
      }
      label {
        font-weight: bold;
      }
      select, input[type="text"], button {
        padding: 8px;
        font-size: 1rem;
        border-radius: 5px;
        border: 1px solid #ccc;
        width: 100%;
      }
      #translateBtn {
        background-color: #4CAF50;
        color: white;
        cursor: pointer;
        border: none;
        font-weight: bold;
      }
      #translateBtn:hover {
        background-color: #45a049;
      }
      #translatedText {
        margin-top: 16px;
        padding: 10px;
        border-radius: 5px;
        background-color: #f2f2f2;
        min-height: 40px;
        white-space: pre-wrap;
      }
        body.dark-mode #modeInstructions {
          color: #ccc;
        }

        @font-face {
      font-family: 'Squartiqa 4F';
      src: url('/static/fonts/Squartiqa4F.woff2') format('woff2'),
           url('/static/fonts/Squartiqa4F.woff') format('woff'),
           url('/static/fonts/Squartiqa4F.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }

    .squartiqa {
      font-family: 'Squartiqa 4F', sans-serif;
    }


    </style>
</head>
<body>
<!-- ========== INTRO SCREEN ========== -->
<div id="introScreen" aria-label="Welcome Screen" role="dialog" aria-modal="true">
    <div class="eyes" aria-hidden="true">
        <div class="eye"></div>
        <div class="eye"></div>
    </div>
    <div id="introText">
        <div id="introLine1">Hello there, friend</div>
        <div id="introLine2">I'm <span class="squartiqa">WREN</span></div>
        <!-- Star SVG -->
        <svg id="introStar" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="60" height="60"
             aria-hidden="true" focusable="false">
            <polygon points="32,4 39,24 60,24 42,38 48,60 32,46 16,60 22,38 4,24 25,24" fill="#1e88e5"/>
        </svg>
    </div>
</div>

<!-- ========== MAIN APP ========== -->
<main role="main" aria-live="polite" style="display:none;">
    <h1 id="mainTitle">üëã Meet WREN ‚Äî Your AI Companion</h1>



    <!-- Dark Mode Toggle -->
    <label for="darkModeToggle" id="darkModeLabel" style="user-select:none; margin-bottom: 10px; cursor:pointer;">
        <input type="checkbox" id="darkModeToggle"/> Toggle Dark Mode
    </label>
    

    <div id="startContainer" class="input-group">
        <label for="nameInput" id="nameLabel">üìù Enter your name:</label>
        <input
                type="text"
                id="nameInput"
                placeholder="Your name here..."
                autocomplete="off"
                aria-describedby="nameLabel"
        />
        <button id="startBtn">
            <span class="icon">‚û§</span> Send
        </button>
    </div>



    <!-- ========== RESPONSE + VIDEO INFO ========== -->
    <div id="response" aria-live="polite"></div>
    <div id="video-info"></div>

    <!-- ========== MODE UI CONTAINER ========== -->
    <div id="modeUIContainer">
        <section
                id="modeSection"
                aria-label="Mode Selection and Interaction"
                style="display: none;"
        >
            <!-- Mode Selector -->
            <label for="modeInput" id="modeLabel">üéØ Choose a Mode:</label>
            <select
                    id="modeInput"
                    aria-describedby="modeInstructions"
                    aria-required="true"
            >
                <option value="">-- Select a Mode --</option>
                <option value="1">ü§ñ Name Recognition</option>
                <option value="math">üßÆ Math Problem Solver</option>
                <option value="science">üî¨ Science Explainer</option>
                <option value="book">üìö Book Recommender</option>
                <option value="budget">üí∞ Budget Tracker</option>
                <option value="depression">ü©∫ Depression Screening</option>
                <option value="tidy">üè† House Tidying</option>
                <option value="logs">üìú Memory Logs</option>
                <option value="voice" disabled title="Premium feature - available to subscribers only">üéô Voice GUI Assistant (Premium)</option>
                <option value="translate">üåê Translate</option>
                <option value="10">üìù Reminder (task list)</option>
            </select>


            <!-- Mode Instructions -->
            <div
                    id="modeInstructions"
                    aria-live="polite"
                    aria-atomic="true"
                    style="margin-top: 10px;"
            ></div>

            <!-- General Input Group -->
            <div id="modeTextInputGroup" class="input-group" style="display: none;">
                <label for="modeTextInput">Your input:</label>
                <input
                        type="text"
                        id="modeTextInput"
                        placeholder="Enter your question or info..."
                />
            </div>

            <!-- Query Input Group -->
            <div id="queryInputGroup" class="input-group" style="display: none;">
                <label for="user-input">Ask a question:</label>
                <input
                        type="text"
                        id="user-input"
                        placeholder="Ask a question..."
                        autocomplete="off"
                />
            </div>

            <!-- House Tidying Input Group -->
            <div id="tidyingInstructions" style="margin-top: 10px; display: none;">
                <label for="tidyingTopic" id="tidyingTopicLabel">
                    üè† What area would you like help tidying?
                    <span style="display: block; font-size: 0.9em; color: #666; margin-top: 4px;">
      Try one of these: <strong>cleaning</strong>, <strong>energy</strong>,
      <strong>security</strong>, <strong>organization</strong>,
      <strong>automation</strong>
    </span>
                </label>
                <input
                        type="text"
                        id="tidyingTopic"
                        placeholder="e.g., cleaning, organization, energy..."
                        autocomplete="off"
                        style="margin-top: 8px;"
                />
            </div>
        </section>
    </div>

    <div id="bookCategoryGroup" style="margin-top: 20px; display: none;">
        <label for="bookCategory" id="bookCategoryLabel">Choose a book category:</label>
        <select id="bookCategory" aria-describedby="bookCategoryLabel">
            <option value="">-- Select a Category --</option>
            <option value="fantasy">fantasy</option>
            <option value="science">science</option>
            <option value="adventure">adventure</option>
            <option value="romance">romance</option>
            <option value="comedy">comedy</option>
        </select>
    </div>

    <div id="bookTypeGroup" style="margin-top: 16px; display: none;">
        <label id="bookTypeLabel">What kind of recommendation do you want?</label><br/>
        <label><input type="radio" name="bookType" value="1"/> üìñ Book</label><br/>
        <label><input type="radio" name="bookType" value="2"/> üéß Audiobook/Video</label><br/>
        <label><input type="radio" name="bookType" value="3" checked/> üìö + üéß Both</label>
    </div>


    <div id="translationOptions" style="display: none; flex-direction: column; gap: 12px; margin-top: 20px;">
        <label for="textToTranslate">Text to Translate:</label>
        <input type="text" id="textToTranslate" placeholder="Enter text here..." autocomplete="off"/>

        <label for="translateFrom">Translate From:</label>
        <select id="translateFrom"></select>

        <label for="translateTo">Translate To:</label>
        <select id="translateTo"></select>

        <button id="translateBtn">Translate</button>

        <!-- Loading + Output wrapped in the same section -->
        <div id="loadingIndicator" style="display: none;">üîÑ Translating...</div>
        <div id="translatedText" style="margin-top: 10px; white-space: pre-wrap;"></div>
    </div>


    <div id="budgetChatContainer"
         style="display:none; border: 1px solid #2b6be6; padding: 10px; height: 300px; overflow-y: auto; margin-top: 20px; background: #f9f9f9;">
        <div id="finalScoreDisplay" style="display: none; font-weight: bold; margin-top: 10px;"></div>
    </div>


    <button id="sendBtn" style="display:none; margin-top: 20px;">Send</button>

    <div id="output" style="white-space: pre-wrap; margin-top: 20px;"></div>

    <div id="modeResponse" aria-live="polite" aria-atomic="true" style="margin-top: 20px;"></div>


</main>

<script>
    let currentUserId = null;
    let depressionScore = 0;
    let userInput = '';




    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('change', () => {
      document.body.classList.toggle('dark-mode', darkModeToggle.checked);
    });

    // Elements
    const startBtn = document.getElementById('startBtn');
    const responseDiv = document.getElementById('response');
    const modeSection = document.getElementById('modeSection');
    const modeInput = document.getElementById('modeInput');
    const sendBtn = document.getElementById('sendBtn');
    const modeResponse = document.getElementById('modeResponse');
    const nameInput = document.getElementById('nameInput');
    const bookCategoryGroup = document.getElementById('bookCategoryGroup');
    const bookCategorySelect = document.getElementById('bookCategory');
    const bookTypeGroup = document.getElementById('bookTypeGroup');
    const modeInstructions = document.getElementById('modeInstructions');
    const translationOptions = document.getElementById('translationOptions');
    const voiceBtn = document.getElementById('voiceBtn');
    const voiceResponse = document.getElementById('voiceResponse');

    async function startSession(username) {
  try {
    const response = await fetch('/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: username }),
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'Failed to start session.');
    }

    // Store the userId (which is the sanitized name from backend)
    localStorage.setItem('userId', data.userId);
    return data.userId;
  } catch (error) {
    alert('Error starting session: ' + error.message);
    return null;
  }
}



function fetchLogs() {
  fetch('/logs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId: currentUserId })
  })
  .then(res => res.json())
  .then(data => {
    if (data.logs && Array.isArray(data.logs)) {
      const logHtml = data.logs.map(entry => `
        <div style="margin-bottom: 12px;">
          <strong>[${entry.timestamp}]</strong><br>
          <strong>You:</strong> ${entry.question}<br>
          <strong>WREN:</strong> ${entry.response}<br>
          <em>Emotion:</em> ${entry.emotion}<br>
          ${entry.tags?.length ? `<em>Tags:</em> ${entry.tags.join(', ')}` : ''}
          ${entry.belief_tags?.length ? `<br><em>Beliefs:</em> ${entry.belief_tags.join(', ')}` : ''}
        </div>
        <hr>
      `).join('');

      modeResponse.innerHTML = logHtml;
    } else {
      modeResponse.textContent = '‚ö†Ô∏è No memory logs found.';
    }
  })
  .catch(err => {
    console.error('[logs fetch error]', err);
    modeResponse.textContent = '‚ö†Ô∏è Error retrieving memory logs.';
  });
}

window.addEventListener('load', async () => {
  // You need to define username here or fetch it from somewhere
  // For example, from an input or localStorage:
  const username = localStorage.getItem('username') || ''; // or get from input

  if (username) {
    const userId = await startSession(username);
    if (!userId) {
      // handle error if session didn't start properly
      return;
    }
  }

  const intro = document.getElementById('introScreen');
  const main = document.querySelector('main');

  setTimeout(() => {
    intro.classList.add('fade-out');
    intro.addEventListener(
      'transitionend',
      () => {
        intro.style.display = 'none';
        main.style.display = 'block';
        requestAnimationFrame(() => {
          main.classList.add('fade-in');
          document.getElementById('nameInput').focus();
        });
      },
      { once: true }
    );
  }, 9000);
});


    const languages = {
    auto: "Auto Detect",
    en: "English",
    es: "Spanish",
    fr: "French",
    de: "German",
    zh: "Chinese",
    ja: "Japanese",
    ru: "Russian",
    ar: "Arabic",
    hi: "Hindi"
    // add more as needed
  };


    const translateFrom = document.getElementById('translateFrom');
  const translateTo = document.getElementById('translateTo');

  // Populate translateFrom dropdown with Auto Detect + all languages
  function populateTranslateFrom() {
    for (const [code, name] of Object.entries(languages)) {
      const option = document.createElement('option');
      option.value = code;
      option.textContent = name;
      translateFrom.appendChild(option);
    }
    translateFrom.value = 'auto'; // default
  }

  // Populate translateTo dropdown (exclude Auto Detect)
  function populateTranslateTo() {
    for (const [code, name] of Object.entries(languages)) {
      if (code === 'auto') continue; // skip auto for target language
      const option = document.createElement('option');
      option.value = code;
      option.textContent = name;
      translateTo.appendChild(option);
    }
    translateTo.value = 'en'; // default target language
  }

  populateTranslateFrom();
  populateTranslateTo();

  async function translate() {
  // Get text and trim
  const text = document.getElementById('textToTranslate').value.trim();
  if (!text) {
    alert('Please enter some text to translate.');
    return;
  }

  // Get source and target languages
  const source_lang = document.getElementById('translateFrom').value; // make sure IDs match your HTML
  const target_lang = document.getElementById('translateTo').value;

  // Output div and loading indicator
  const outputDiv = document.getElementById('translatedText'); // or translationOutput ‚Äî pick one and keep consistent
  const loading = document.getElementById('loadingIndicator'); // optional, if you have a loading spinner div

  // Get userId or prompt
  let userId = localStorage.getItem('userId');
  if (!userId) {
    userId = prompt("Enter your username:");
    if (!userId) {
      alert("Username is required!");
      return;
    }
    localStorage.setItem('userId', userId);
  }

  outputDiv.textContent = '';
  if (loading) loading.style.display = 'block';

  try {
    const response = await fetch('/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: userId,
        mode: 'translate',
        input: text,
        user_translate: true,
        ai_translate: false,
        target_lang: target_lang,
        source_lang: source_lang,
        user_name: userId,
        memory_logger: null
      }),
    });

    const data = await response.json();

    if (data.success) {
      outputDiv.textContent = data.ai_response || data.translated_input || 'No response';
    } else {
      outputDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
    }
  } catch (error) {
    outputDiv.textContent = 'Network error: ' + error.message;
  } finally {
    if (loading) loading.style.display = 'none';
  }
}


async function ensureSession(userId) {
  const response = await fetch('/create_session', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ userId }),
  });
  const data = await response.json();
  if (!data.success) {
    alert('Failed to create user session: ' + (data.error || 'Unknown error'));
  }
}

async function startApp() {
    const userId = localStorage.getItem('userId') || prompt("Enter your username:");
    if (!userId) {
      alert("Username is required!");
      return;
    }

    localStorage.setItem('userId', userId);
    await ensureSession(userId);
  }

  document.addEventListener('DOMContentLoaded', startApp);



    function updateDepressionScoreDisplay() {
  const scoreDiv = document.getElementById('finalScoreDisplay');
  if (!scoreDiv) return;

  if (depressionScore > 0) {
    scoreDiv.textContent = `üß† Screening Score: ${depressionScore}`;
    scoreDiv.style.display = 'block';
  } else {
    scoreDiv.style.display = 'none';
  }
}




    // Update UI based on mode selection
    function updateModeUI() {
  const selected = modeInput.value;
  const modeSection = document.getElementById('modeSection');
  const queryInputGroup = document.getElementById('queryInputGroup');
  const modeTextInputGroup = document.getElementById('modeTextInputGroup');
  const chatContainer = document.getElementById('budgetChatContainer');

  // Elements that should be defined globally or declared above:
  // bookCategoryGroup, bookTypeGroup, translationOptions, modeInstructions, modeResponse, sendBtn

  // Reset sendBtn visibility by default (show it unless overridden)
  sendBtn.style.display = 'inline-block';

  // Show or hide mode section
  modeSection.style.display = selected ? 'block' : 'none';

  // Show or hide budget chat container
  chatContainer.style.display = selected === 'budget' ? 'block' : 'none';

  // Hide all optional UI elements by default
  queryInputGroup.style.display = 'none';
  modeTextInputGroup.style.display = 'none';
  bookCategoryGroup.style.display = 'none';
  bookTypeGroup.style.display = 'none';
  translationOptions.style.display = 'none';

  // Clear instructions and response
  modeInstructions.textContent = '';
  modeResponse.textContent = '';

  switch (selected) {
    case 'math':
    case 'science':
      queryInputGroup.style.display = 'block';
      modeInstructions.textContent = `Enter your ${selected === 'math' ? 'math problem' : 'science question'} above and click Send.`;
      break;

    case 'tidy':
      // No queryInputGroup or modeTextInputGroup shown here
      modeInstructions.innerHTML = `
        <label for="tidyingTopic">
          üè† What area would you like help tidying?
          <span style="display: block; font-size: 0.9em; color: #808080; margin-top: 4px;">
            Try one of these: <strong>cleaning</strong>, <strong>energy</strong>,
            <strong>security</strong>, <strong>organization</strong>,
            <strong>automation</strong>
          </span>
        </label>
        <input
          type="text"
          id="tidyingTopic"
          placeholder="e.g., cleaning, organization, energy..."
          autocomplete="off"
          style="margin-top: 8px;"
        />
      `;
      break;

    case 'book':
      bookCategoryGroup.style.display = 'block';
      bookTypeGroup.style.display = 'block';
      modeInstructions.textContent = 'Select a book category and type, then click Send.';
      break;

    case 'depression':
      modeTextInputGroup.style.display = 'block';
      modeResponse.style.display = 'block';
      modeInstructions.textContent = 'Hello there friend, to get started please enter a number from 0 to 3 to start the depression screening.';

      depressionStep = 0;
      depressionAnswers = [];
      depressionScore = 0;
      updateDepressionScoreDisplay();

      fetch('/mode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: currentUserId, mode: 'depression', input: '' })
      })
      .then(res => res.json())
      .then(data => {
        if (data && data.response) {
          if (typeof data.score === 'number') {
            depressionScore = data.score;
            updateDepressionScoreDisplay();
          }
          modeResponse.innerHTML = data.response.replace(/\n/g, '<br>');
        }
      })
      .catch(() => {
        // If fetch fails, instructions remain visible
      });
      break;

    case 'translate':
      translationOptions.style.display = 'block';
      modeInstructions.textContent = 'Select languages and click Translate.';
      sendBtn.style.display = 'none'; // Hide send button, show translate button handled elsewhere
      document.getElementById('translateBtn').style.display = 'inline-block';
      break;

    case 'budget':
      modeTextInputGroup.style.display = 'block';
      modeInstructions.textContent = 'Enter your savings goal and click Send.';
      chatContainer.innerHTML = '';

      // Show bot typing indicator
      const botMessage = document.createElement('div');
      botMessage.textContent = 'WREN is typing...';
      botMessage.style.fontStyle = 'italic';
      chatContainer.appendChild(botMessage);

      fetch('/mode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: currentUserId, mode: 'budget', input: '' }),
      })
      .then(res => res.json())
      .then(data => {
        chatContainer.removeChild(botMessage);
        if (data && typeof data.response === 'string' && data.response.trim() !== '') {
          const botReply = document.createElement('div');
          botReply.innerHTML = typeof markdownToHtml === 'function'
            ? markdownToHtml(data.response)
            : data.response;
          chatContainer.appendChild(botReply);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      })
      .catch(error => {
        console.error('Budget welcome error:', error);
        chatContainer.removeChild(botMessage);
        const errorDiv = document.createElement('div');
        errorDiv.textContent = '‚ùå Failed to load budget intro.';
        chatContainer.appendChild(errorDiv);
      });
      break;

    case '1': // Name Recognition
      modeTextInputGroup.style.display = 'block';
      modeInstructions.textContent = 'Enter your name and click Send.';
      break;

    case 'logs':
      modeTextInputGroup.style.display = 'none';
      queryInputGroup.style.display = 'none';
      modeInstructions.textContent = 'üìú Displaying your memory log...';
      modeResponse.textContent = 'Loading...';
      fetchLogs();
      break;

    case '10': // Reminder mode (number or string)
    case 'reminder':
      modeTextInputGroup.style.display = 'block';
      queryInputGroup.style.display = 'none';
      chatContainer.style.display = 'none'; // hide budget container if shown previously

      modeInstructions.innerHTML = `
        üìù <strong>Task Reminder Mode</strong><br><br>
        Use commands like:
        <ul style="margin-top: 4px; padding-left: 20px; font-size: 0.95em;">
          <li><code>add Call mom at 5pm</code></li>
          <li><code>view</code></li>
          <li><code>check_due</code></li>
          <li><code>clear</code></li>
        </ul>
        Enter your command below and click <strong>Send</strong>.
      `;
      modeResponse.textContent = '';
      break;

    default:
      modeInstructions.textContent = 'Please enter your input and click Send.';
      sendBtn.style.display = 'inline-block';
      break;
  }
}


    modeInput.addEventListener('change', updateModeUI);
   startBtn.addEventListener("click", async () => {
  const name = nameInput.value.trim();

  if (!name) {
    responseDiv.innerText = "‚ö†Ô∏è Please enter your name first.";
    return;
  }

  try {
    // Send name to backend to start session or register user
    const response = await fetch("/start", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ name })
    });

    const result = await response.json();

    if (result.success) {
      currentUserId = result.userId;

      responseDiv.innerText = result.response || `üëã Hello, ${name}! Please interact below to see what I can do for you!`;

      // Show mode selection section, focus input
      modeSection.style.display = 'block';
      modeInput.focus();

      // Disable start inputs & button to prevent re-submission
      startBtn.disabled = true;
      nameInput.disabled = true;

      // Show send button for further interactions
      sendBtn.style.display = 'inline-block';
    } else {
      responseDiv.innerText = `‚ùå ${result.error || 'Unknown error'}`;
    }
  } catch (error) {
    console.error("Error:", error);
    responseDiv.innerText = "‚ùå Something went wrong. Try again.";
  }
});

    sendBtn.addEventListener('click', async () => {
  const mode = modeInput.value;
  if (!validateMode(mode)) return;
  if (!validateSession()) return;

  try {
    sendBtn.disabled = true;
    modeResponse.textContent = '‚è≥ Processing...';

    switch (mode) {
      case 'book':
        await handleBookMode();
        break;
      case 'budget':
        await handleBudgetMode();
        break;
      case 'logs':
        await fetchLogs();
        break;
      case 'tidy':
        await handleTidyMode();
        break;
      case 'translate':
        await handleTranslateMode();
        break;
      case 'voice':
        console.warn('Voice mode is not yet implemented.');
        modeResponse.textContent = 'üõë Voice mode is currently unavailable.';
        break;
      case 'reminder':
      case '10':
        await handleReminderMode();
        break;
      case 'science':
      case 'math':
        await handleGenericMode(mode);
        break;

      default:
        modeResponse.textContent = `‚ö†Ô∏è Unknown mode: ${mode}`;
        break;
    }
  } catch (err) {
    console.error('Error in mode handler:', err);
    modeResponse.textContent = `‚ùå ${err.message || 'Unexpected error.'}`;
  } finally {
    sendBtn.disabled = false;
  }
});

// ======= VALIDATION HELPERS =======
function validateMode(mode) {
  if (!mode) {
    modeResponse.textContent = '‚ö†Ô∏è Please select a mode.';
    return false;
  }
  return true;
}

function validateSession() {
  if (!currentUserId) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter your name and start first.';
    return false;
  }
  return true;
}

// ======= SHARED UTILS =======
async function postMode(payload) {
  const res = await fetch('/mode', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return res.json();
}

function markdownToHtml(markdown = '') {
  // Bold
  let html = markdown.replace(/(?:\*\*|__)(.*?)\1/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/(?:\*|_)(.*?)\1/g, '<em>$1</em>');
  // Numbered list items
  html = html.replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>');

  // Wrap list items in <ol>
  // This finds consecutive <li>...</li> blocks and wraps them once in <ol>...</ol>
  html = html.replace(/(?:<li>.*?<\/li>\s*)+/gs, match => `<ol>${match}</ol>`);

  // Replace remaining newlines with <br>
  html = html.replace(/\n/g, '<br>');

  return html;
}


// ---- DEPRESSION CHECKER ----
let depressionStep = 0;
let depressionAnswers = [];

async function handleDepressionMode() {
  const inputEl = document.getElementById('modeTextInput');
  const input = inputEl.value.trim();
  if (!input) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter your response above.';
    return;
  }

  // Disable input and send button during request to prevent double submit
  inputEl.disabled = true;
  sendButton.disabled = true;

  // Show user input and typing message inside modeResponse
  modeResponse.innerHTML = `<p><strong>You:</strong> ${escapeHtml(input)}</p><p><em>WREN is typing...</em></p>`;

  const payload = {
    userId: currentUserId,
    mode: 'depression',
    step: depressionStep,
    answer: input,
    answers: depressionAnswers
  };

  try {
    const data = await postMode(payload);

    if (!data || data.success === false) {
      modeResponse.innerHTML = `<p>‚ö†Ô∏è ${escapeHtml(data?.error || 'Request failed.')}</p>`;
    } else {
      depressionStep = data.next_step ?? depressionStep;
      depressionAnswers = data.answers ?? depressionAnswers;

      let responseHtml = '';

      if (data.message?.trim()) {
        responseHtml += `<p>${markdownToHtml(data.message)}</p>`;
      }

      // If process is done, reset steps and answers
      if (data.done) {
        depressionStep = 0;
        depressionAnswers = [];
      }

      modeResponse.innerHTML = responseHtml;
    }
  } catch (err) {
    modeResponse.innerHTML = `<p>‚ùå Error: ${escapeHtml(err.message)}</p>`;
  } finally {
    inputEl.value = '';
    inputEl.disabled = false;
    sendButton.disabled = false;
    inputEl.focus();
  }
}

// Helper to escape HTML (to avoid injection)
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}



// ======= MODE HANDLERS =======

// ---- BOOK ----
async function handleBookMode() {
  const selectedCategory = bookCategorySelect.value.toLowerCase();
  const selectedType = document.querySelector('input[name="bookType"]:checked')?.value;
  const topic = document.getElementById('modeTextInput').value.trim();

  if (!selectedCategory || !selectedType) {
    modeResponse.textContent = '‚ö†Ô∏è Please select both a book category and type.';
    return;
  }

  const payload = {
    userId: currentUserId,
    mode: 'book',
    bookCategory: selectedCategory,
    bookType: selectedType,
    topic
  };

  modeResponse.textContent = 'üìö Fetching recommendations...';
  const data = await postMode(payload);

  if (!data.success) {
    modeResponse.textContent = `‚ö†Ô∏è ${data.error || 'Failed to get recommendations.'}`;
    return;
  }

  let html = `<p>Here are some recommendations:</p>`;
  if (data.book) {
    const { title, author } = data.book;
    html += `<p>üìñ <strong>${title || 'Unknown Title'}</strong> by ${author || 'Unknown Author'}</p>`;
  }

  if (Array.isArray(data.audiobooks) && data.audiobooks.length) {
    const links = data.audiobooks
      .map(a => `<a href="${a.url}" target="_blank">${a.title}</a>`)
      .join(', ');
    html += `<p>üéß Audiobooks: ${links}</p>`;
  }

  modeResponse.innerHTML = html;
}




// ============== Task reminder =============
async function handleReminderMode() {
  const input = modeTextInput.value.trim();
  if (!input) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter a reminder command.';
    return;
  }

  try {
    const response = await fetch('/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: currentUserId,
        mode: 'reminder',
        input
      }),
    });

    const data = await response.json();

    if (data && data.success) {
      modeResponse.innerHTML = data.response.replace(/\n/g, '<br>');
    } else if (data && data.error) {
      modeResponse.textContent = `‚ö†Ô∏è ${data.error}`;
    } else {
      modeResponse.textContent = '‚ö†Ô∏è Unexpected response.';
    }
  } catch (error) {
    console.error('Reminder mode error:', error);
    modeResponse.textContent = '‚ùå Failed to process your reminder.';
  }
}
// ---- TIDY ----
async function handleTidyMode() {
  const topic = document.getElementById('tidyingTopic')?.value.trim();
  if (!topic) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter a tidying topic.';
    return;
  }

  modeResponse.textContent = 'Tidying up...';
  const data = await postMode({
    userId: currentUserId,
    mode: 'tidy',
    input: topic
  });

  modeResponse.innerHTML = data?.response?.replace(/\n/g, '<br>') || '‚ö†Ô∏è No response received.';
}

// ---- BUDGET ----
async function handleBudgetMode() {
  const input = document.getElementById('modeTextInput').value.trim();
  if (!input) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter your input above.';
    return;
  }

  const chatContainer = document.getElementById('budgetChatContainer');
  appendChat(chatContainer, `You: ${input}`, true);
  document.getElementById('modeTextInput').value = '';

  const typingMsg = appendChat(chatContainer, 'WREN is typing...', false, true);
  const payload = { userId: currentUserId, mode: 'budget', input };

  try {
    const data = await postMode(payload);
    chatContainer.removeChild(typingMsg);

    if (!data || data.success === false) {
      appendChat(chatContainer, `‚ö†Ô∏è ${data?.error || 'Request failed.'}`);
    } else if (data.response?.trim()) {
      appendChat(chatContainer, markdownToHtml(data.response));
    } else {
      appendChat(chatContainer, '‚ö†Ô∏è No response from backend.');
    }
  } catch (err) {
    chatContainer.removeChild(typingMsg);
    appendChat(chatContainer, `‚ùå Error: ${err.message}`);
  }
}

function appendChat(container, text, isUser = false, italic = false) {
  const div = document.createElement('div');
  div.innerHTML = text;
  div.style.marginBottom = '8px';
  if (isUser) div.style.fontWeight = 'bold';
  if (italic) div.style.fontStyle = 'italic';
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

// ---- TRANSLATE ----
async function handleTranslateMode() {
  const from = document.getElementById('translateFrom').value;
  const to = document.getElementById('translateTo').value;
  const inputText = document.getElementById('modeTextInput').value.trim();

  if (!inputText) {
    modeResponse.textContent = '‚ö†Ô∏è Please enter text to translate.';
    return;
  }

  const payload = {
    userId: currentUserId,
    mode: 'translate',
    translateFrom: from,
    translateTo: to,
    input: inputText
  };

  const data = await postMode(payload);
  modeResponse.innerHTML = data.response || '‚úÖ Translation complete.';
}

// ---- GENERIC / FALLBACK ----
async function handleGenericMode(mode) {
  const inputElement =
    mode === 'math' || mode === 'science'
      ? document.getElementById('user-input')
      : document.getElementById('modeTextInput');

  const input = inputElement?.value.trim();
  const payload = { userId: currentUserId, mode, input };

  console.log('Payload being sent:', payload);

  const res = await fetch('/mode', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);

  let fullResponse;

  if (mode === 'science') {
    // string-based logic, no JSON parsing
    fullResponse = await res.text();
  } else {
    // JSON-based logic (math or other modes)
    const data = await res.json();
    fullResponse = data.response?.trim();
  }

  const formattedHtml = markdownToHtml(fullResponse || '‚ö†Ô∏è No answer received.');
  modeResponse.innerHTML = formattedHtml;

  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

// ======= KEEP YOUR EXISTING DOMContentLoaded LOGIC BELOW =======
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('translateBtn').addEventListener('click', translate);

  // Existing book category fetch, start session, etc.
  const bookCategoryDropdown = document.getElementById('bookCategory');
  if (bookCategoryDropdown) {
    fetch('/api/book-categories')
      .then(response => response.json())
      .then(categories => {
        bookCategoryDropdown.innerHTML = '<option value="">-- Select a Category --</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.toLowerCase();
          option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
          bookCategoryDropdown.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Failed to load book categories:', error);
        bookCategoryDropdown.innerHTML = '<option value="">‚ö†Ô∏è Failed to load</option>';
      });
  }

  const startSessionBtn = document.getElementById('startSessionBtn');
  const usernameInput = document.getElementById('usernameInput');

  if (startSessionBtn && usernameInput) {
    startSessionBtn.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      if (!username) {
        alert('Please enter your name.');
        return;
      }

      const userId = await startSession(username);
      if (userId) {
        alert(`Session started for ${username}`);
        localStorage.setItem('userId', userId);
      }
    });
  }
});



</script>

<style>



    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background: white;
      color: #333;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-mode {
      background-color: #121212;
      color: #eee;
    }

    .fade-out {
      opacity: 0;
      transition: opacity 1s ease-out;
    }

    .fade-in {
      opacity: 1;
      transition: opacity 1s ease-in;
    }

    #introScreen {
      text-align: center;
      margin-top: 100px;
      font-size: 1.5rem;
    }

    #introStar {
      margin-top: 20px;
      fill: #1e88e5;
    }

    label {
      font-weight: bold;
    }

    input[type="text"], select {
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 10px;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 4px;
    }

    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    a {
      color: #1e88e5;
    }

    a:hover {
      text-decoration: underline;
    }
</style>
</body>
